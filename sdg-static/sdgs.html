<!doctype html>
<html>
<head>
<title>UN SDGs</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" text="text/css" href="sdgStyles.css" />
</head>
<body>

  
  <div id="miniHeader"><img src="UNimages/un17banner.png" height="70px"></div>

  <div id="twopics">
    <div id='p1'><img src="//placehold.it/150x150"></div>
    <div id='p2'><img src="//placehold.it/150x150"></div>
  </div>

  <button id="spin">Spin</button>
  <div id="top5"></div>

<script src="unObjects.js"></script>
<script src="makePairs.js"></script>
<script src="sdgSupport.js"></script>
<script>

document.getElementById('twopics').addEventListener('click',winner);
document.getElementById('spin').addEventListener('click', createPair);


// function to turn unObjects.js focusAreas into JSON
function convertFocusAreasToJSON () {
  let focusAreasJSON = JSON.stringify(focusAreas);
  localStorage.setItem('focusAreasJSON', focusAreasJSON);
}

// function to create considerLater empty array if it doesn't exist
// function createConsiderLater () {
//   if (!localStorage.getItem('considerLater')) { considerLater(e); };
// createConsiderLater();

// create location to store not-interested-in-these-goals right now list
(function considerLater (e) {
  if (!localStorage.getItem('considerLater')) {
  const considerLater = [];
  localStorage.setItem('considerLater', JSON.stringify(considerLater) );
  }
})();


// function winner() adds score to the clicked item, stores other info, and gets a new pair
// need to work on scoring methods and algorithm. start by being able to keep score of what is picked
// and maybe store the pair it beat. Need to decide storage method. Maybe mongodb. Maybe node.js. Maybe firebase.

let iAmClicked = '';

function winner (e) {
  let clicked = e.target.parentNode;
  let matchState = JSON.parse(localStorage.getItem('focusAreasJSON'));
  
  function recordMatch (a,b) {
    matchState[unPick[a]].pairs.push(unPick[b]);
  }
  
  if ( clicked.id === 'p1') {
    let a = 0; let b = 1; //index of pairs in id=p1 and id=p2
    let p1score = matchState[unPick[a]].score;
    p1score = p1score + 1;
    matchState[unPick[a]].score = p1score;
    recordMatch(a,b);
    localStorage.setItem('focusAreasJSON', JSON.stringify(matchState));
    createPair();
  } else { 
    let a = 1; let b = 0; //index of pairs in id=p1 and id=p2
    let p2score = matchState[unPick[a]].score;
    p2score = p2score + 1;
    matchState[unPick[a]].score = p2score;
    recordMatch(a,b);
    localStorage.setItem('focusAreasJSON', JSON.stringify(matchState));
    createPair();
  }
}


// get a random integer in a range
function getRandom(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

let unPick = []; 

// create a pair of SDGs to chose a winner from
function createPair () {

const considerLater = JSON.parse(localStorage.getItem('considerLater'));  
  //this is to eliminate certain sdgs from the contest; adds things to considerLater array
        let bailOnThis = slug => e => {
          let considerLater = JSON.parse(localStorage.getItem('considerLater'));
          e.stopPropagation();
          considerLater.push(slug);
          let indexOfConsiderLater = unPick.indexOf(slug);
          console.log("index is", indexOfConsiderLater);
          unPick = new Set(unPick);
          unPick.delete(slug);
          unPick = [...unPick];
          localStorage.setItem('considerLater', JSON.stringify(considerLater));
          pickRandom();
          console.log("new unPick", unPick);
          if (indexOfConsiderLater === 0) {
            unPick = unPick.reverse();
              document.getElementById('p1').innerHTML = `<img id="p1img" src=${focusAreaDetails[unPick[0]].image}><div id="info1">${focusAreaDetails[unPick[0]].info}<i class="material-icons" id="p1x">highlight_off</i></div>`;
              document.getElementById('p1x').addEventListener('click', bailOnThis(focusAreaDetails[unPick[0]].slug));
            return unPick;
          } else {
              document.getElementById('p2').innerHTML = `<img id="p2img" src=${focusAreaDetails[unPick[1]].image}><div id="info2">${focusAreaDetails[unPick[1]].info}<i class="material-icons" id="p2x">highlight_off</i></div>`;
              document.getElementById('p2x').addEventListener('click', bailOnThis(focusAreaDetails[unPick[1]].slug));            
            return unPick;
          }
        }  

  
  if (!localStorage.getItem('focusAreasJSON')) { convertFocusAreasToJSON(); }; // check that JSON object for focusAreas exists & create if it doesn't
  let focusAreaDetails = JSON.parse(localStorage.getItem('focusAreasJSON')); //returns object with all details, for slug, img source, label, etc.
  let areaList = Object.keys(JSON.parse(localStorage.getItem('focusAreasJSON'))); //a list of focus areas to get length

// pickRandom() -- get a random sdg, check it, when good, add to unPick array
    function pickRandom() {
      let pick = focusAreaDetails[areaList[getRandom(0, areaList.length - 1)]].slug;
      if ( considerLater.includes(pick) || unPick.includes(pick)) {
        return pickRandom();
      } else {
        unPick.push(pick);
        return unPick;
      }
    }
    
  //run pickRandom() two times to create a pair assigned to unPick array
  unPick = [];
  for (i=0; i<2; i++) {
    pickRandom();
  }


//event listeners to show images and x's to add things to considerLater list
  document.getElementById('p1').innerHTML = `<img id="p1img" src=${focusAreaDetails[unPick[0]].image}><div id="info1">${focusAreaDetails[unPick[0]].info}<i class="material-icons" id="p1x">highlight_off</i></div>`;
  document.getElementById('p1x').addEventListener('click', bailOnThis(focusAreaDetails[unPick[0]].slug));
  document.getElementById('p2').innerHTML = `<img id="p2img" src=${focusAreaDetails[unPick[1]].image}><div id="info2">${focusAreaDetails[unPick[1]].info}<i class="material-icons" id="p2x">highlight_off</i></div>`;
  document.getElementById('p2x').addEventListener('click', bailOnThis(focusAreaDetails[unPick[1]].slug));

}


createPair(); // this initializes the web page with a pair to pick from

// add links to un sdg sites for more info or actions
// add a link to play a video
// add credits for the app and un site
// make a function to just replace a single sdg when putting one on considerLater
// test in mobile phone
// find out about pwa without framework (can you?)
// add arrow icon or other icon to get a new pair of sdgs
// add some instructions, including tool-tip hoover info
// consider doing images as a sprite sheet
// define layout for showing top 3 picks in order
// function to remove an sdg from considerLater

</script>
</body>
</html>